#!/usr/bin/env node
const fs = require('fs')
const ora = require('ora')
const path = require('path')
const chalk = require('chalk')
const home = require('user-home')
const inquirer = require('inquirer')
const commander = require('commander')
const download = require('download-git-repo')

//===== Usage. =====
commander
  .usage('<template-name> [project-name]')
  .option('-n', 'null')

//===== Help. =====

commander.on('--help', function () {
  console.log('  Examples:\n')
  console.log('    # create a new project with a yhtml5 template')
  console.log(chalk.cyan('    $ yhtml5 init project-name\n'))
})

function help () {
  commander.parse(process.argv)
  if (commander.args.length < 1) return commander.help()
}

help()

//===== Settings. =====
const rawName = process.argv[2]
const inPlace = !rawName || rawName === '.'
const name = inPlace ? path.relative('../', process.cwd()) : rawName
const to = path.resolve(rawName || '.')
const clone = commander.clone || false

const tmp = path.join(home, '.yhtml5', template.replace(/\//g, '-'))

if (commander.offline) {
  console.log(`> Use cached template at ${chalk.yellow(tildify(tmp))}`)
  template = tmp
}

//===== Padding. =====
process.on('exit', function () {
  console.log()
})

if (fs.existsSync(to)) {
  inquirer
    .prompt([
      {
        name: 'ok',
        type: 'confirm',
        message: inPlace
          ? 'Generate project in current directory?'
          : 'Target directory exists. Continue?',
      }])
    .then(function (answers) {
      if (answers.ok) {
        ask()
      }
    })
} else {
  ask()
}

function ask () {
  inquirer
    .prompt([
      {
        name: 'type',
        type: 'list',
        message: 'which template do you need ?',
        choices: [
          'react (This version only supports react)',
          'vue (No support yet)',
          'angular (No support yet)']
      }])
    .then(function (answers) {
      console.log('done!', answers)
      run('react')
    })
}

//===== Check, download and generate the project. =====

function run (template) {
  downloadAndGenerate(template)
}

function downloadAndGenerate (template) {
  console.log('downloadAndGenerate!')
  const spinner = ora('downloading template')
  spinner.start()
  download(template, tmp, {clone: clone}, function (err) {
    spinner.stop()
    if (err) console.error(chalk.red('Failed to download repo ' + template + ': ' + err.message.trim()))
    generate(name, tmp, to, function (err) {
      if (err) console.error(chalk.red(err))
      console.log(chalk.green('Generated "%s".', name))
    })
  })
}

function generate () {
  console.log('generate!')
}

function done () {
  console.log('done!')
}

// console.log(chalk.yellow('    yellow'), chalk.red('red'), chalk.green('green'), chalk.blue('blue'), chalk.magenta('magenta'), chalk.cyan('cyan'), chalk.white('white'), chalk.gray('gray\n\n'))
// console.log('done!')